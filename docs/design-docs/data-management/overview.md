# 売上分析データ管理機能 - 機能概要

## 機能概要

売上分析データ管理機能は、既存農家が売上分析で使用するデータ（売上記録、作物情報、販売チャンネル情報）を表形式で閲覧・編集できる機能です。ユーザーが直接データを管理することで、より正確で実情に合った分析結果を得られるようにします。

## 目的

### 主要目的
1. **データの透明性確保**: 分析に使用されるデータをユーザーが確認・把握できる
2. **データ品質の向上**: ユーザー自身による正確なデータ入力・修正
3. **分析精度の向上**: 実情に合ったデータによる、より有用な分析結果の提供
4. **ユーザー主導性の実現**: 農家自身がデータを管理・コントロールできる環境

### 解決する課題
- 売上分析のデータが不正確または古い情報のまま固定されている
- ユーザーが分析結果の根拠となるデータを確認できない
- サンプルデータのままで実際の経営状況が反映されていない
- 作物情報や販売チャンネル情報が実態と乖離している

## 対象ユーザー

- **既存農家**: 売上分析機能を使用している農家
- **データ精度を重視するユーザー**: 正確な分析結果を求める農家
- **複数作物・複数チャンネルの農家**: 多様な販売戦略を持つ農家

## 主要機能

### 1. 売上記録管理
- **機能**: 売上記録データの表形式での閲覧・編集・削除
- **データ項目**: 日付、作物、数量、単価、合計金額、販売先、メモ
- **操作**: 新規追加、既存データの編集、行削除
- **バリデーション**: 必須項目チェック、数値範囲チェック、日付妥当性チェック

### 2. 作物情報管理
- **機能**: 栽培作物のマスタ情報管理
- **データ項目**: 作物名、カテゴリ、単位、標準単価、説明
- **操作**: 新規作物追加、情報更新、無効化（削除ではなく）
- **連携**: 売上記録の作物選択肢として使用

### 3. 販売チャンネル管理
- **機能**: 販売先のマスタ情報管理
- **データ項目**: チャンネル名、表示名、手数料率、連絡先、メモ
- **操作**: 新規チャンネル追加、情報更新、無効化
- **連携**: 売上記録の販売先選択肢として使用

### 4. リアルタイム反映
- **機能**: データ編集後の即座なグラフ更新
- **対象**: 売上分析画面のすべてのグラフ・チャート
- **処理**: データ変更検知、自動再計算、UI更新

## データ構造

### 売上記録（SalesRecord）
```typescript
interface SalesRecord {
  id: number                // 一意識別子
  date: string             // 販売日（ISO形式）
  crop: string            // 作物ID（作物マスタと連携）
  quantity: number        // 数量
  unit: string           // 単位（kg, 箱等）
  unitPrice: number      // 単価
  total: number          // 合計金額（自動計算）
  channel: string        // 販売チャンネルID
  notes?: string         // メモ（任意）
  createdAt: string      // 作成日時
  updatedAt: string      // 更新日時
}
```

### 作物情報（CropInfo）
```typescript
interface CropInfo {
  id: string              // 作物ID（例: grape, potato）
  name: string           // 表示名（例: ぶどう、じゃがいも）
  category: string       // カテゴリ（果物、野菜等）
  defaultUnit: string    // 標準単位
  standardPrice: number  // 標準単価（参考値）
  description?: string   // 説明
  isActive: boolean      // 有効フラグ
  createdAt: string      // 作成日時
  updatedAt: string      // 更新日時
}
```

### 販売チャンネル情報（SalesChannel）
```typescript
interface SalesChannel {
  id: string              // チャンネルID（例: wholesale_market）
  name: string           // 内部名（例: wholesale_market）
  displayName: string    // 表示名（例: よ市）
  commissionRate?: number // 手数料率（%）
  contactInfo?: string   // 連絡先
  notes?: string         // メモ
  isActive: boolean      // 有効フラグ
  createdAt: string      // 作成日時
  updatedAt: string      // 更新日時
}
```

## UI/UX要件

### アクセス方法
1. **売上分析画面からのアクセス**: 「データを編集」ボタンを配置
2. **専用管理画面**: `/existing-farmer/data-management`として独立ページ
3. **ダッシュボードからの直接アクセス**: クイックアクションとして配置

### レイアウト構成
1. **ヘッダー**: ページタイトル、戻るボタン、保存状態表示
2. **タブナビゲーション**: 売上記録・作物情報・販売チャンネルの切り替え
3. **データテーブル**: 各データの表形式表示・編集
4. **アクションエリア**: 新規追加、インポート・エクスポート等

### インタラクション
- **インライン編集**: テーブル内での直接編集
- **モーダル編集**: 複雑な編集時の専用ダイアログ
- **即座保存**: 編集内容の自動保存
- **リアルタイム反映**: 分析画面への即座反映

### データテーブル機能
- **ソート**: 各列でのソート機能
- **フィルタ**: 日付範囲、作物、チャンネル等での絞り込み
- **検索**: 全項目横断検索
- **ページネーション**: 大量データ対応
- **選択**: 複数行選択・一括操作

## 技術要件

### 使用技術
- **フレームワーク**: Next.js 15 + TypeScript
- **UIコンポーネント**: shadcn/ui（Table, Dialog, Form等）
- **データ管理**: React状態管理 + カスタムフック
- **バリデーション**: Zod スキーマバリデーション
- **データ永続化**: Database（将来的にPrisma + PostgreSQL）

### パフォーマンス要件
- **データロード**: 1,000件の記録を3秒以内で表示
- **編集レスポンス**: インライン編集の即座反映（100ms以内）
- **保存処理**: データ保存を1秒以内で完了
- **グラフ更新**: データ変更からグラフ反映まで2秒以内

### セキュリティ要件
- **入力検証**: クライアント・サーバーサイド両方でのバリデーション
- **XSS対策**: 入力値のサニタイゼーション
- **データ整合性**: 外部キー制約、データ型チェック
- **操作ログ**: データ変更の記録（将来機能）

## データフロー

### 1. データ読み込みフロー
```
ページアクセス → データベースクエリ → 状態管理にセット → テーブル表示
```

### 2. データ編集フロー
```
ユーザー編集 → バリデーション → ローカル状態更新 → データベース保存 → 分析画面更新
```

### 3. リアルタイム反映フロー
```
データ変更検知 → 分析データ再計算 → グラフコンポーネント更新
```

## 成功指標

### 機能完成の定義
1. ✅ 売上記録の表形式表示・編集が可能
2. ✅ 作物情報の管理が可能
3. ✅ 販売チャンネル情報の管理が可能
4. ✅ データ編集後のリアルタイムグラフ反映
5. ✅ データベースへの永続化機能
6. ✅ バリデーション・エラーハンドリング

### ユーザビリティ目標
- **直感性**: 初回利用時に操作方法が理解できる
- **効率性**: 大量データの効率的な編集が可能
- **信頼性**: データの整合性が常に保たれる
- **即応性**: 編集結果が即座に分析に反映される

## データ移行・初期化

### 既存データの移行
1. **サンプルデータ**: 既存のサンプルデータをデータベースに移行
2. **マスタデータ**: 作物・チャンネルのマスタデータを初期化
3. **日々の記録連携**: 既存の日々の記録データとの統合

### 初回セットアップ
1. **基本作物**: よく使用される作物の事前登録
2. **基本チャンネル**: 一般的な販売チャンネルの事前登録
3. **サンプルデータ**: デモ用のサンプル売上記録

## 将来拡張

### Phase 2での拡張予定
- **データインポート**: CSV、Excel等からの一括インポート
- **データエクスポート**: 分析用データの外部出力
- **履歴管理**: データ変更履歴の保持・復元
- **一括編集**: 複数レコードの一括更新機能

### Phase 3での拡張予定
- **データ検証**: 異常値検知・データ品質チェック
- **自動補完**: 過去データからの入力補完機能
- **テンプレート**: よく使用するデータパターンの保存
- **権限管理**: ユーザー別のデータアクセス制御

## 関連機能との連携

### 売上分析機能との連携
- **データソース**: 編集されたデータを分析の入力として使用
- **リアルタイム更新**: データ変更時の分析結果即座更新
- **整合性保証**: マスタデータと売上記録の整合性確保

### 日々の記録機能との連携
- **データ統合**: 日々の記録データと売上記録データの統合
- **重複防止**: 同じデータの重複登録防止
- **入力補完**: 過去の記録からの入力候補提示

---

**作成日**: 2024年12月  
**最終更新**: 2024年12月

